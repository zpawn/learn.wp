/* Copyright (C) YOOtheme GmbH, http://www.gnu.org/licenses/gpl.html GNU/GPL */

(function($,global){$(function(){$("main.tm-main > .tm-form").append('<div class="tm-form-save"><button type="submit" class="uk-button uk-button-primary js-save-settings">Save changes</button> <span></span></div>');var checkboxes=$('input:checkbox[name$="[title]"]');$.each(checkboxes,function(){$(this).after($(this).clone().attr("type","hidden").val($(this).is(":checked")?"1":"0"))});checkboxes.on("change",function(){$(this).next().val($(this).is(":checked")?"1":"0")});$('[data-warp="theme"] .js-save-settings').on("click",function(e){e.preventDefault();System.save(this)})});var System={save:function(btn){var config={},button=$(btn);button.attr("disabled",true).next().attr("class","uk-icon-spinner uk-icon-spin");parse_str($(":input","#theme-options").serialize(),config);$.ajax({url:ajaxurl,type:"post",data:{action:"warp_save",config:JSON.stringify(config,null,"	")},success:function(data){var success=false;try{data=$.parseJSON(data);if(data.message=="success"){success=true}}catch(e){}if(!success){alert("Save failed!")}setTimeout(function(){button.attr("disabled",false).next().attr("class","")},300)}})},saveFiles:function(params){var deferred=$.Deferred();var data=new FormData;data.append("action","warp_save_files");data.append("files",new Blob([window.btoa(JSON.stringify(params))],{type:"text/plain"}));$.ajax({url:ajaxurl,type:"POST",data:data,processData:false,contentType:false}).always(function(data,txtstatus,message){var error=false;if(txtstatus=="error"){error=message}else{try{data=$.parseJSON(data);if(data.message!="success"){error=data.message}}catch(e){error="Saving failed!"}}deferred[error?"reject":"resolve"](error)});return deferred.promise()},data:function(){var deferred=$.Deferred();$.ajax({url:ajaxurl,type:"post",data:{action:"warp_get_styles"}}).always(function(data,txtstatus,message){var error=false;if(txtstatus=="error"){error=message}else{try{data=$.parseJSON(data);if(data.message=="error"){error=data.message}else{deferred.resolve(data);return}}catch(e){error="Retrieving styles data failed!"}}deferred.reject(error)});return deferred.promise()}};global.System=System})(jQuery,this);